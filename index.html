<!    const beat=Math.sin(2*Math.PI*beatFreq*t)>0?0.6:0.1;
    data[i]=(melody*beat)*Math.exp(-t/duration);
  }

  const src=ctx.createBufferSource();
  src.buffer=buffer;
  src.connect(ctx.destination);
  src.start();

  audioBuffer=buffer;
  document.getElementById("status").innerText=
  "âœ… Ready: "+mode.toUpperCase()+" BEAT";
}

function download(){
  if(!audioBuffer)return;
  const wav=encodeWAV(audioBuffer.getChannelData(0));
  const blob=new Blob([wav],{type:"audio/wav"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="AI_"+currentMode+"_Beat_"+Date.now()+".wav";
  a.click();
}

function encodeWAV(samples){
  const buffer=new ArrayBuffer(44+samples.length*2);
  const view=new DataView(buffer);
  const rate=44100;
  function w(o,s){for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
  w(0,"RIFF");
  view.setUint32(4,36+samples.length*2,true);
  w(8,"WAVE");
  w(12,"fmt ");
  view.setUint32(16,16,true);
  view.setUint16(20,1,true);
  view.setUint16(22,1,true);
  view.setUint32(24,rate,true);
  view.setUint32(28,rate*2,true);
  view.setUint16(32,2,true);
  view.setUint16(34,16,true);
  w(36,"data");
  view.setUint32(40,samples.length*2,true);
  let o=44;
  for(let i=0;i<samples.length;i++){
    let s=Math.max(-1,Math.min(1,samples[i]));
    view.setInt16(o,s<0?s*0x8000:s*0x7fff,true);
    o+=2;
  }
  return view;
}
</script>

</body>
  </html>
    
